---
# Ansible Inventory: Staging Environment
# Usage: ansible-playbook -i inventory/staging.yml playbooks/setup-api.yml
# ALIGNED WITH CI/CD WORKFLOW - Last updated: 2026-01-31

all:
  children:
    api_servers:
      hosts:
        api-staging-01:
          ansible_host: 165.227.129.93 # Primary staging droplet (Frankfurt)
          ansible_user: deploy
          ansible_ssh_private_key_file: ~/.ssh/staging_deploy_ed25519
          ansible_python_interpreter: /usr/bin/python3

        api-staging-02:
          ansible_host: 161.35.21.86 # Secondary staging droplet (Frankfurt)
          ansible_user: deploy
          ansible_ssh_private_key_file: ~/.ssh/staging_deploy_ed25519
          ansible_python_interpreter: /usr/bin/python3

      vars:
        environment: staging
        node_env: production # Staging runs in production mode (aligned with CI/CD)
        api_port: 3002 # Changed from 3001 to match CI/CD
        enable_do_monitoring: true
        enable_node_exporter: true

        # Application configuration
        app_name: restomarket-api
        app_directory: /opt/app

        # Docker configuration
        docker_compose_version: '2.24.5'

        # Deploy user configuration
        deploy_user: deploy
        deploy_user_uid: 1001

        # Security configuration
        ssh_port: 22
        fail2ban_enabled: true

        # Monitoring configuration
        node_exporter_version: '1.7.0'

        # Load balancer and CORS origins
        load_balancer_ip: 157.245.21.33
        cors_origins: 'http://157.245.21.33,http://165.227.129.93,http://161.35.21.86'

        # API Deployment configuration (update-api.yml)
        docker_registry_url: ghcr.io
        docker_registry_username: "{{ lookup('env', 'GITHUB_ACTOR') | default('yonko-bc') }}"
        docker_image_name: restomarket-api
        api_health_check_url: 'http://localhost:3002/v1/health' # Fixed: added /v1 prefix
        api_health_check_timeout: 60
        api_rollback_on_failure: true

        # Environment variables (from GitHub Secrets)
        database_url: "{{ lookup('env', 'DATABASE_URL') }}"
        redis_url: "{{ lookup('env', 'REDIS_URL') }}"
        log_level: info
        api_prefix: v1
