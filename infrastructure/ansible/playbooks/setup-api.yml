---
# Ansible Playbook: Initial API Server Setup
# Purpose: Configure fresh DigitalOcean droplets with Docker, security hardening, and monitoring
# Usage: ansible-playbook -i inventory/dev.yml playbooks/setup-api.yml

- name: Setup API Server with Docker and Security Hardening
  hosts: api_servers
  become: true
  gather_facts: true

  vars:
    deploy_user: deploy
    deploy_user_uid: 1001
    app_directory: /opt/app
    docker_compose_version: '2.24.5'
    node_exporter_version: '1.7.0'

  pre_tasks:
    - name: Update apt cache
      apt:
        update_cache: true
        cache_valid_time: 3600

  tasks:
    # ============================================================
    # System Updates and Prerequisites
    # ============================================================
    - name: Upgrade all packages to the latest version
      apt:
        upgrade: dist
        update_cache: true
      register: apt_upgrade
      retries: 3
      delay: 10
      until: apt_upgrade is success

    - name: Install required system packages
      apt:
        name:
          - apt-transport-https
          - ca-certificates
          - curl
          - gnupg
          - lsb-release
          - software-properties-common
          - ufw
          - fail2ban
          - unattended-upgrades
          - git
          - htop
          - vim
          - jq
        state: present
        update_cache: true

    # ============================================================
    # Docker Installation
    # ============================================================
    - name: Add Docker GPG key
      apt_key:
        url: https://download.docker.com/linux/ubuntu/gpg
        state: present
        keyring: /usr/share/keyrings/docker-archive-keyring.gpg

    - name: Add Docker repository
      apt_repository:
        repo: 'deb [arch=amd64 signed-by=/usr/share/keyrings/docker-archive-keyring.gpg] https://download.docker.com/linux/ubuntu {{ ansible_distribution_release }} stable'
        state: present
        filename: docker

    - name: Install Docker Engine
      apt:
        name:
          - docker-ce
          - docker-ce-cli
          - containerd.io
          - docker-buildx-plugin
          - docker-compose-plugin
        state: present
        update_cache: true

    - name: Ensure Docker service is started and enabled
      systemd:
        name: docker
        state: started
        enabled: true

    - name: Add Docker daemon configuration
      copy:
        content: |
          {
            "log-driver": "json-file",
            "log-opts": {
              "max-size": "10m",
              "max-file": "3"
            },
            "live-restore": true,
            "userland-proxy": false
          }
        dest: /etc/docker/daemon.json
        mode: '0644'
      notify: Restart Docker

    # ============================================================
    # Docker Compose Installation
    # ============================================================
    - name: Download Docker Compose binary
      get_url:
        url: 'https://github.com/docker/compose/releases/download/v{{ docker_compose_version }}/docker-compose-linux-x86_64'
        dest: /usr/local/bin/docker-compose
        mode: '0755'

    - name: Verify Docker Compose installation
      command: docker-compose --version
      register: docker_compose_version_output
      changed_when: false

    - name: Display Docker Compose version
      debug:
        msg: '{{ docker_compose_version_output.stdout }}'

    # ============================================================
    # Deploy User Creation
    # ============================================================
    - name: Create deploy user group
      group:
        name: '{{ deploy_user }}'
        gid: '{{ deploy_user_uid }}'
        state: present

    - name: Create deploy user
      user:
        name: '{{ deploy_user }}'
        uid: '{{ deploy_user_uid }}'
        group: '{{ deploy_user }}'
        groups: docker
        shell: /bin/bash
        create_home: true
        home: '/home/{{ deploy_user }}'
        state: present

    - name: Add SSH authorized keys for deploy user
      authorized_key:
        user: '{{ deploy_user }}'
        state: present
        key: "{{ lookup('file', item) }}"
      with_fileglob:
        - '{{ playbook_dir }}/../keys/*.pub'
      when: lookup('fileglob', playbook_dir + '/../keys/*.pub', errors='ignore') | length > 0

    - name: Create application directory
      file:
        path: '{{ app_directory }}'
        state: directory
        owner: '{{ deploy_user }}'
        group: '{{ deploy_user }}'
        mode: '0755'

    - name: Add deploy user to sudoers with NOPASSWD for specific commands
      copy:
        content: |
          # Allow deploy user to restart services and run Docker commands
          {{ deploy_user }} ALL=(ALL) NOPASSWD: /usr/bin/systemctl restart docker
          {{ deploy_user }} ALL=(ALL) NOPASSWD: /usr/bin/docker *
          {{ deploy_user }} ALL=(ALL) NOPASSWD: /usr/local/bin/docker-compose *
        dest: '/etc/sudoers.d/{{ deploy_user }}'
        mode: '0440'
        validate: 'visudo -cf %s'

    # ============================================================
    # UFW Firewall Configuration
    # ============================================================
    - name: Configure UFW defaults
      ufw:
        direction: '{{ item.direction }}'
        policy: '{{ item.policy }}'
      loop:
        - { direction: 'incoming', policy: 'deny' }
        - { direction: 'outgoing', policy: 'allow' }

    - name: Allow SSH through firewall
      ufw:
        rule: limit
        port: '22'
        proto: tcp
        comment: 'SSH rate limited'

    - name: Allow HTTP traffic
      ufw:
        rule: allow
        port: '80'
        proto: tcp
        comment: 'HTTP'

    - name: Allow HTTPS traffic
      ufw:
        rule: allow
        port: '443'
        proto: tcp
        comment: 'HTTPS'

    - name: Allow API port
      ufw:
        rule: allow
        port: '{{ api_port }}'
        proto: tcp
        comment: 'API application port ({{ api_port }})'
      when: api_port is defined

    - name: Enable UFW
      ufw:
        state: enabled

    # ============================================================
    # SSH Hardening
    # ============================================================
    - name: Harden SSH configuration
      lineinfile:
        path: /etc/ssh/sshd_config
        regexp: '{{ item.regexp }}'
        line: '{{ item.line }}'
        state: present
        backup: true
      loop:
        - { regexp: '^#?PermitRootLogin', line: 'PermitRootLogin no' }
        - { regexp: '^#?PasswordAuthentication', line: 'PasswordAuthentication no' }
        - { regexp: '^#?PubkeyAuthentication', line: 'PubkeyAuthentication yes' }
        - { regexp: '^#?PermitEmptyPasswords', line: 'PermitEmptyPasswords no' }
        - { regexp: '^#?X11Forwarding', line: 'X11Forwarding no' }
        - { regexp: '^#?MaxAuthTries', line: 'MaxAuthTries 3' }
        - { regexp: '^#?ClientAliveInterval', line: 'ClientAliveInterval 300' }
        - { regexp: '^#?ClientAliveCountMax', line: 'ClientAliveCountMax 2' }
      notify: Restart SSH

    # ============================================================
    # Fail2ban Configuration
    # ============================================================
    - name: Configure Fail2ban for SSH
      copy:
        content: |
          [sshd]
          enabled = true
          port = ssh
          filter = sshd
          logpath = /var/log/auth.log
          maxretry = 3
          bantime = 3600
          findtime = 600
        dest: /etc/fail2ban/jail.d/sshd.conf
        mode: '0644'
      notify: Restart Fail2ban

    - name: Ensure Fail2ban is started and enabled
      systemd:
        name: fail2ban
        state: started
        enabled: true

    # ============================================================
    # Automatic Security Updates
    # ============================================================
    - name: Configure unattended upgrades
      copy:
        content: |
          APT::Periodic::Update-Package-Lists "1";
          APT::Periodic::Download-Upgradeable-Packages "1";
          APT::Periodic::AutocleanInterval "7";
          APT::Periodic::Unattended-Upgrade "1";
        dest: /etc/apt/apt.conf.d/20auto-upgrades
        mode: '0644'

    - name: Configure unattended upgrades allowed origins
      copy:
        content: |
          Unattended-Upgrade::Allowed-Origins {
              "${distro_id}:${distro_codename}-security";
              "${distro_id}ESMApps:${distro_codename}-apps-security";
              "${distro_id}ESM:${distro_codename}-infra-security";
          };
          Unattended-Upgrade::AutoFixInterruptedDpkg "true";
          Unattended-Upgrade::MinimalSteps "true";
          Unattended-Upgrade::Remove-Unused-Kernel-Packages "true";
          Unattended-Upgrade::Remove-Unused-Dependencies "true";
          Unattended-Upgrade::Automatic-Reboot "false";
        dest: /etc/apt/apt.conf.d/50unattended-upgrades
        mode: '0644'

    # ============================================================
    # DigitalOcean Monitoring Agent (Optional)
    # ============================================================
    - name: Check if DigitalOcean monitoring should be installed
      set_fact:
        install_do_agent: '{{ enable_do_monitoring | default(true) }}'

    - name: Download DigitalOcean monitoring agent
      get_url:
        url: https://repos.insights.digitalocean.com/install.sh
        dest: /tmp/do-agent-install.sh
        mode: '0755'
      when: install_do_agent | bool

    - name: Install DigitalOcean monitoring agent
      command: bash /tmp/do-agent-install.sh
      args:
        creates: /opt/digitalocean/bin/do-agent
      when: install_do_agent | bool

    - name: Remove DigitalOcean agent installer
      file:
        path: /tmp/do-agent-install.sh
        state: absent
      when: install_do_agent | bool

    # ============================================================
    # Node Exporter for Prometheus (Optional)
    # ============================================================
    - name: Check if Node Exporter should be installed
      set_fact:
        install_node_exporter: '{{ enable_node_exporter | default(false) }}'

    - name: Create node_exporter user
      user:
        name: node_exporter
        system: true
        shell: /bin/false
        create_home: false
      when: install_node_exporter | bool

    - name: Download Node Exporter
      get_url:
        url: 'https://github.com/prometheus/node_exporter/releases/download/v{{ node_exporter_version }}/node_exporter-{{ node_exporter_version }}.linux-amd64.tar.gz'
        dest: /tmp/node_exporter.tar.gz
      when: install_node_exporter | bool

    - name: Extract Node Exporter
      unarchive:
        src: /tmp/node_exporter.tar.gz
        dest: /tmp
        remote_src: true
      when: install_node_exporter | bool

    - name: Install Node Exporter binary
      copy:
        src: '/tmp/node_exporter-{{ node_exporter_version }}.linux-amd64/node_exporter'
        dest: /usr/local/bin/node_exporter
        mode: '0755'
        owner: node_exporter
        group: node_exporter
        remote_src: true
      when: install_node_exporter | bool

    - name: Create Node Exporter systemd service
      copy:
        content: |
          [Unit]
          Description=Node Exporter
          After=network.target

          [Service]
          Type=simple
          User=node_exporter
          Group=node_exporter
          ExecStart=/usr/local/bin/node_exporter
          Restart=on-failure

          [Install]
          WantedBy=multi-user.target
        dest: /etc/systemd/system/node_exporter.service
        mode: '0644'
      when: install_node_exporter | bool
      notify: Reload systemd and restart Node Exporter

    - name: Clean up Node Exporter installation files
      file:
        path: '{{ item }}'
        state: absent
      loop:
        - /tmp/node_exporter.tar.gz
        - '/tmp/node_exporter-{{ node_exporter_version }}.linux-amd64'
      when: install_node_exporter | bool

    # ============================================================
    # System Tuning
    # ============================================================
    - name: Configure sysctl for production
      sysctl:
        name: '{{ item.name }}'
        value: '{{ item.value }}'
        state: present
        reload: true
      loop:
        - { name: 'net.core.somaxconn', value: '65535' }
        - { name: 'net.ipv4.tcp_max_syn_backlog', value: '8192' }
        - { name: 'net.ipv4.tcp_tw_reuse', value: '1' }
        - { name: 'net.ipv4.ip_local_port_range', value: '1024 65535' }
        - { name: 'vm.swappiness', value: '10' }
        - { name: 'fs.file-max', value: '2097152' }

    - name: Set file descriptor limits
      pam_limits:
        domain: '*'
        limit_type: '{{ item.type }}'
        limit_item: nofile
        value: '{{ item.value }}'
      loop:
        - { type: 'soft', value: '65536' }
        - { type: 'hard', value: '65536' }

    # ============================================================
    # Cleanup and Final Checks
    # ============================================================
    - name: Clean apt cache
      apt:
        autoclean: true
        autoremove: true

    - name: Display setup summary
      debug:
        msg:
          - '=============================================='
          - 'API Server Setup Complete'
          - '=============================================='
          - 'Docker version: {{ docker_compose_version_output.stdout }}'
          - 'Deploy user: {{ deploy_user }}'
          - 'App directory: {{ app_directory }}'
          - 'UFW firewall: Enabled'
          - 'SSH hardening: Applied'
          - 'Fail2ban: Enabled'
          - 'Automatic updates: Enabled'
          - "DigitalOcean monitoring: {{ 'Installed' if install_do_agent else 'Skipped' }}"
          - "Node Exporter: {{ 'Installed' if install_node_exporter else 'Skipped' }}"
          - '=============================================='
          - 'Next steps:'
          - '1. Deploy application with update-api.yml playbook'
          - '2. Configure environment variables'
          - '3. Verify health checks'
          - '=============================================='

  handlers:
    - name: Restart Docker
      systemd:
        name: docker
        state: restarted

    - name: Restart SSH
      systemd:
        name: sshd
        state: restarted

    - name: Restart Fail2ban
      systemd:
        name: fail2ban
        state: restarted

    - name: Reload systemd and restart Node Exporter
      systemd:
        daemon_reload: true
        name: node_exporter
        state: restarted
        enabled: true
