---
# Ansible Playbook: Update API with Zero-Downtime Deployment
#
# This playbook deploys API updates using a blue-green deployment strategy
# to ensure zero downtime during deployments.
#
# Usage:
#   ansible-playbook playbooks/update-api.yml -i inventory/dev.yml \
#     -e "image_tag=sha-abc1234 environment=dev"
#
# Required Variables:
#   - image_tag: Docker image tag to deploy (e.g., sha-abc1234, main, develop)
#   - environment: Target environment (dev, staging, production)
#
# Optional Variables:
#   - registry_url: Docker registry URL (default: ghcr.io)
#   - registry_username: Docker registry username (default: from inventory)
#   - health_check_url: Health check endpoint (default: http://localhost:3001/health)
#   - health_check_timeout: Max wait time for health check in seconds (default: 60)
#   - rollback_on_failure: Rollback to previous version on failure (default: true)

- name: Deploy API with Zero-Downtime (Blue-Green Strategy)
  hosts: api_servers
  become: yes
  gather_facts: yes

  vars:
    # Default configuration (can be overridden in inventory or command line)
    registry_url: "{{ docker_registry_url | default('ghcr.io') }}"
    registry_username: "{{ docker_registry_username | default(lookup('env', 'GITHUB_ACTOR')) }}"
    image_name: "{{ docker_image_name | default('restomarket-api') }}"
    container_port: '{{ api_port | default(3001) }}'
    host_port: '{{ api_port | default(3001) }}'
    health_check_url: "{{ api_health_check_url | default('http://localhost:' + (container_port | string) + '/health') }}"
    health_check_timeout: '{{ api_health_check_timeout | default(60) }}'
    health_check_interval: 5
    rollback_on_failure: '{{ api_rollback_on_failure | default(true) }}'
    app_directory: '/opt/app'

    # Computed variables
    full_image_name: '{{ registry_url }}/{{ registry_username }}/{{ image_name }}:{{ image_tag }}'

  pre_tasks:
    - name: Validate required variables
      assert:
        that:
          - image_tag is defined
          - environment is defined
          - environment in ['dev', 'staging', 'production']
        fail_msg: "Required variables missing. Usage: -e 'image_tag=sha-abc1234 environment=dev'"

    - name: Display deployment information
      debug:
        msg:
          - 'Deploying {{ full_image_name }}'
          - 'Environment: {{ environment }}'
          - 'Health check: {{ health_check_url }}'
          - 'Rollback on failure: {{ rollback_on_failure }}'

  tasks:
    # ============================================
    # Pre-Deployment: Backup Current State
    # ============================================

    - name: Get current running container
      command: docker ps --filter "name=restomarket-api-" --format "{{ '{{' }}.Names{{ '}}' }}"
      register: current_container
      changed_when: false
      failed_when: false

    - name: Store current container name
      set_fact:
        old_container: "{{ current_container.stdout | default('') }}"

    - name: Get current image tag (for rollback)
      command: docker inspect {{ old_container }} --format "{{ '{{' }}.Config.Image{{ '}}' }}"
      register: current_image
      changed_when: false
      failed_when: false
      when: old_container != ''

    - name: Store previous image for rollback
      set_fact:
        rollback_image: "{{ current_image.stdout | default('') }}"
      when: old_container != ''

    - name: Display current state
      debug:
        msg:
          - "Current container: {{ old_container | default('none') }}"
          - "Current image: {{ rollback_image | default('none') }}"

    # ============================================
    # Step 1: Pull New Docker Image
    # ============================================

    - name: Log in to Docker registry
      command: >
        docker login {{ registry_url }}
        -u {{ registry_username }}
        -p {{ docker_registry_token }}
      no_log: true
      when: docker_registry_token is defined

    - name: Pull new Docker image
      docker_image:
        name: '{{ full_image_name }}'
        source: pull
        force_source: yes
      register: pull_result
      retries: 3
      delay: 10
      until: pull_result is succeeded

    # ============================================
    # Step 2: Determine Blue/Green Container
    # ============================================

    - name: Determine new container name (blue-green)
      set_fact:
        new_container: "{{ 'restomarket-api-blue' if (old_container == 'restomarket-api-green' or old_container == '') else 'restomarket-api-green' }}"

    - name: Display container names
      debug:
        msg:
          - "Old container: {{ old_container | default('none') }}"
          - 'New container: {{ new_container }}'

    # ============================================
    # Step 3: Start New Container
    # ============================================

    - name: Create application directory
      file:
        path: '{{ app_directory }}'
        state: directory
        owner: deploy
        group: deploy
        mode: '0755'

    - name: Start new container
      docker_container:
        name: '{{ new_container }}'
        image: '{{ full_image_name }}'
        state: started
        restart_policy: unless-stopped
        ports:
          - '{{ host_port }}:{{ container_port }}'
        env:
          NODE_ENV: '{{ node_env }}'
          DATABASE_URL: '{{ database_url }}'
          REDIS_URL: '{{ redis_url }}'
          APP_PORT: '{{ container_port }}'
          CORS_ORIGINS: '{{ cors_origins }}'
          LOG_LEVEL: '{{ log_level }}'
          API_PREFIX: '{{ api_prefix }}'
        networks:
          - name: bridge
        healthcheck:
          test: ['CMD', 'curl', '-f', '{{ health_check_url }}']
          interval: 10s
          timeout: 5s
          retries: 3
          start_period: 30s
        labels:
          environment: '{{ environment }}'
          deployment_time: '{{ ansible_date_time.iso8601 }}'
      register: container_start

    - name: Wait for container to be running
      wait_for:
        timeout: 10
      delegate_to: localhost

    # ============================================
    # Step 4: Health Check
    # ============================================

    - name: Wait for application health check
      uri:
        url: '{{ health_check_url }}'
        method: GET
        status_code: 200
        timeout: 5
      register: health_check
      retries: '{{ (health_check_timeout | int / health_check_interval | int) | int }}'
      delay: '{{ health_check_interval }}'
      until: health_check.status == 200
      failed_when: false

    - name: Check if health check passed
      assert:
        that:
          - health_check.status == 200
        fail_msg: 'Health check failed after {{ health_check_timeout }}s'
        success_msg: 'Health check passed!'

    # ============================================
    # Step 5: Stop Old Container
    # ============================================

    - name: Stop old container
      docker_container:
        name: '{{ old_container }}'
        state: stopped
      when: old_container != ''
      register: old_container_stopped

    - name: Wait for graceful shutdown
      wait_for:
        timeout: 10
      delegate_to: localhost
      when: old_container != ''

    - name: Remove old container
      docker_container:
        name: '{{ old_container }}'
        state: absent
      when: old_container != ''

    # ============================================
    # Step 6: Cleanup Old Images
    # ============================================

    - name: Get all API images
      command: docker images {{ registry_url }}/{{ registry_username }}/{{ image_name }} --format "{{ '{{' }}.Repository{{ '}}' }}:{{ '{{' }}.Tag{{ '}}' }}"
      register: all_images
      changed_when: false

    - name: Keep only last 5 images
      shell: |
        docker images {{ registry_url }}/{{ registry_username }}/{{ image_name }} \
          --format "{{ '{{' }}.Repository{{ '}}' }}:{{ '{{' }}.Tag{{ '}}' }}" | \
          tail -n +6 | \
          xargs -r docker rmi || true
      when: all_images.stdout_lines | length > 5
      changed_when: all_images.stdout_lines | length > 5

    # ============================================
    # Post-Deployment: Verification
    # ============================================

    - name: Verify new container is running
      command: docker ps --filter "name={{ new_container }}" --format "{{ '{{' }}.Status{{ '}}' }}"
      register: container_status
      changed_when: false

    - name: Display deployment success
      debug:
        msg:
          - '‚úÖ Deployment successful!'
          - 'Container: {{ new_container }}'
          - 'Image: {{ full_image_name }}'
          - 'Status: {{ container_status.stdout }}'

  rescue:
    # ============================================
    # Rollback on Failure
    # ============================================

    - name: Deployment failed - Starting rollback
      debug:
        msg: '‚ö†Ô∏è  Deployment failed! Rolling back to previous version...'
      when: rollback_on_failure | bool

    - name: Stop failed new container
      docker_container:
        name: '{{ new_container }}'
        state: stopped
      when: rollback_on_failure | bool
      failed_when: false

    - name: Remove failed new container
      docker_container:
        name: '{{ new_container }}'
        state: absent
      when: rollback_on_failure | bool
      failed_when: false

    - name: Restart old container (rollback)
      docker_container:
        name: '{{ old_container }}'
        image: '{{ rollback_image }}'
        state: started
        restart_policy: unless-stopped
        ports:
          - '{{ host_port }}:{{ container_port }}'
        env:
          NODE_ENV: '{{ node_env }}'
          DATABASE_URL: '{{ database_url }}'
          REDIS_URL: '{{ redis_url }}'
          APP_PORT: '{{ container_port }}'
          CORS_ORIGINS: '{{ cors_origins }}'
          LOG_LEVEL: '{{ log_level }}'
          API_PREFIX: '{{ api_prefix }}'
      when:
        - rollback_on_failure | bool
        - old_container != ''
        - rollback_image != ''

    - name: Get rollback logs
      command: docker logs {{ old_container }} --tail 50
      register: rollback_logs
      when:
        - rollback_on_failure | bool
        - old_container != ''
      changed_when: false
      failed_when: false

    - name: Display rollback status
      debug:
        msg:
          - 'üîÑ Rollback complete'
          - 'Restored container: {{ old_container }}'
          - 'Image: {{ rollback_image }}'
      when:
        - rollback_on_failure | bool
        - old_container != ''

    - name: Fail deployment
      fail:
        msg: 'Deployment failed and rolled back to previous version'
      when: rollback_on_failure | bool

    - name: Fail deployment without rollback
      fail:
        msg: 'Deployment failed (rollback disabled)'
      when: not (rollback_on_failure | bool)

  post_tasks:
    - name: Display current containers
      command: docker ps --filter "name=restomarket-api-" --format "table {{ '{{' }}.Names{{ '}}' }}\t{{ '{{' }}.Image{{ '}}' }}\t{{ '{{' }}.Status{{ '}}' }}"
      register: final_containers
      changed_when: false

    - name: Show final state
      debug:
        msg: '{{ final_containers.stdout_lines }}'
